<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Integral de Obra PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .tab-active { border-bottom: 3px solid #2563eb; color: #2563eb; font-weight: bold; background-color: #eff6ff; }
        .hidden-section { display: none; }
        .quote-card { transition: all 0.3s; border: 2px solid transparent; }
        .quote-selected { border-color: #22c55e; background-color: #f0fdf4; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="text-gray-800">

    <div class="max-w-7xl mx-auto bg-white min-h-screen shadow-2xl relative pb-20">
        
        <header class="bg-slate-900 text-white p-6 shadow-md flex flex-wrap justify-between items-center no-print">
            <div>
                <h1 class="text-2xl font-bold tracking-wider">CONTROL DE OBRA <span class="text-orange-400">MAX</span></h1>
            </div>
            <div class="text-right mt-4 sm:mt-0">
                <input type="text" id="projectName" class="bg-slate-800 text-white border-none text-right font-bold rounded px-2" value="Residencia">
            </div>
        </header>

        <nav class="flex overflow-x-auto bg-white border-b sticky top-0 z-20 shadow-sm no-print">
            <button onclick="showSection('dashboard')" id="btn-dashboard" class="tab-active py-3 px-4 whitespace-nowrap hover:bg-gray-50 text-sm">Dashboard</button>
            <button onclick="showSection('materiales')" id="btn-materiales" class="py-3 px-4 whitespace-nowrap hover:bg-gray-50 text-gray-500 font-medium text-sm">
                <i class="fas fa-boxes mr-1"></i> Compras & Fondo
            </button>
            <button onclick="showSection('estimaciones')" id="btn-estimaciones" class="py-3 px-4 whitespace-nowrap hover:bg-gray-50 text-gray-500 font-medium text-sm">Estimaciones</button>
            <button onclick="showSection('gastos')" id="btn-gastos" class="py-3 px-4 whitespace-nowrap hover:bg-gray-50 text-gray-500 font-medium text-sm">Caja Chica</button>
        </nav>

        <section id="dashboard" class="p-6 space-y-6">
            <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 shadow-sm">
                <h3 class="text-blue-800 font-bold">Estado Financiero</h3>
                <div class="mt-2 flex justify-between text-lg">
                    <span>Presupuesto:</span> 
                    <input type="number" id="budgetInput" onchange="saveBudget()" class="bg-transparent font-bold w-32" placeholder="0">
                </div>
                <div class="flex justify-between text-lg font-bold mt-2">
                    <span>Disponible:</span> <span class="text-green-600" id="displayRestante">$0.00</span>
                </div>
            </div>
        </section>

        <section id="materiales" class="hidden-section p-6 bg-gray-50 min-h-screen">
            
            <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-orange-500 flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-gray-800">Fondo Materiales</h2>
                    <p class="text-xs text-gray-500">Saldo del contratista</p>
                </div>
                <div>
                    <span class="text-sm mr-2">Monto dado: $</span>
                    <input type="number" id="materialFundInput" onchange="updateFund()" class="w-24 border-b font-bold text-center">
                    <div class="text-right text-xs mt-1 font-bold text-orange-600">Disp: <span id="matFundAvailable">$0.00</span></div>
                </div>
            </div>

            <div class="bg-indigo-50 border-2 border-indigo-200 border-dashed rounded-xl p-4 mb-8 text-center">
                <h3 class="text-indigo-900 font-bold text-sm mb-2"><i class="fab fa-whatsapp text-green-500 text-lg mr-2"></i>Cargar Cotización desde WhatsApp</h3>
                <p class="text-xs text-indigo-400 mb-2">Copia el mensaje completo del contratista y pégalo aquí:</p>
                <div class="flex gap-2">
                    <input type="text" id="pasteArea" class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-indigo-500" placeholder="Pegar mensaje aquí...">
                    <button onclick="parseWhatsApp()" class="bg-indigo-600 text-white px-4 rounded font-bold text-sm hover:bg-indigo-700">Cargar</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Comparativa y Registro</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label class="text-xs font-bold text-gray-500">Material</label>
                        <input type="text" id="matName" class="w-full border p-2 rounded bg-gray-50">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Unidad</label>
                        <input type="text" id="matUnit" class="w-full border p-2 rounded bg-gray-50">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Cantidad</label>
                        <input type="number" id="matQty" class="w-full border p-2 rounded bg-gray-50" oninput="calcQuotes()">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="quote-card p-4 rounded bg-gray-50 group relative" id="cardA">
                        <button onclick="selectQuote('A')" class="absolute top-2 right-2 text-xs bg-gray-200 px-2 rounded">Elegir</button>
                        <h4 class="font-bold text-gray-600 text-center text-sm">Opción A</h4>
                        <input type="text" id="provA" class="w-full mb-1 text-sm border p-1" placeholder="Proveedor">
                        <input type="number" id="priceA" class="w-full font-bold border p-1" placeholder="$" oninput="calcQuotes()">
                        <p class="text-center mt-1 text-xs font-bold text-gray-400" id="totalA">$0.00</p>
                    </div>
                    <div class="quote-card p-4 rounded bg-gray-50 group relative" id="cardB">
                        <button onclick="selectQuote('B')" class="absolute top-2 right-2 text-xs bg-gray-200 px-2 rounded">Elegir</button>
                        <h4 class="font-bold text-gray-600 text-center text-sm">Opción B</h4>
                        <input type="text" id="provB" class="w-full mb-1 text-sm border p-1" placeholder="Proveedor">
                        <input type="number" id="priceB" class="w-full font-bold border p-1" placeholder="$" oninput="calcQuotes()">
                        <p class="text-center mt-1 text-xs font-bold text-gray-400" id="totalB">$0.00</p>
                    </div>
                    <div class="quote-card p-4 rounded bg-gray-50 group relative" id="cardC">
                        <button onclick="selectQuote('C')" class="absolute top-2 right-2 text-xs bg-gray-200 px-2 rounded">Elegir</button>
                        <h4 class="font-bold text-gray-600 text-center text-sm">Opción C</h4>
                        <input type="text" id="provC" class="w-full mb-1 text-sm border p-1" placeholder="Proveedor">
                        <input type="number" id="priceC" class="w-full font-bold border p-1" placeholder="$" oninput="calcQuotes()">
                        <p class="text-center mt-1 text-xs font-bold text-gray-400" id="totalC">$0.00</p>
                    </div>
                </div>

                <div class="mt-4 text-right">
                    <button onclick="registerPurchase()" class="bg-green-600 text-white px-6 py-2 rounded shadow font-bold disabled:opacity-50" id="btnBuy" disabled>Registrar Compra Seleccionada</button>
                </div>
            </div>

            <div class="bg-white rounded shadow overflow-hidden">
                <div class="bg-gray-800 text-white p-2 font-bold text-sm">Historial Compras Material</div>
                <div id="materialList" class="divide-y text-sm"></div>
            </div>
        </section>

        <section id="estimaciones" class="hidden-section p-4 text-center">Ver versión anterior para estimaciones completas.</section>
        <section id="gastos" class="hidden-section p-4 text-center">Ver versión anterior para caja chica.</section>

    </div>

    <script>
        // --- BASE DE DATOS ---
        let db = {
            budget: parseFloat(localStorage.getItem('db_budget')) || 0,
            matFund: parseFloat(localStorage.getItem('db_matFund')) || 0,
            materials: JSON.parse(localStorage.getItem('db_materials')) || []
        };
        let selectedQ = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('budgetInput').value = db.budget;
            document.getElementById('materialFundInput').value = db.matFund;
            renderMaterials();
            updateUI();
        });

        function showSection(id) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden-section'));
            document.getElementById(id).classList.remove('hidden-section');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active'));
            document.getElementById('btn-'+id).classList.add('tab-active');
        }

        // --- MAGIA: PARSER WHATSAPP ---
        function parseWhatsApp() {
            const text = document.getElementById('pasteArea').value;
            // Buscar lo que está entre [APP_DATA] y [/APP_DATA]
            const regex = /\[APP_DATA\](.*?)\[\/APP_DATA\]/;
            const match = text.match(regex);

            if (match && match[1]) {
                try {
                    const data = JSON.parse(match[1]);
                    
                    // Llenar formulario automáticamente
                    document.getElementById('matName').value = data.item;
                    document.getElementById('matQty').value = data.qty;
                    document.getElementById('matUnit').value = data.unit;
                    
                    // Llenar cotizaciones
                    if(data.quotes[0]) {
                        document.getElementById('provA').value = data.quotes[0].p;
                        document.getElementById('priceA').value = data.quotes[0].c;
                    }
                    if(data.quotes[1]) {
                        document.getElementById('provB').value = data.quotes[1].p;
                        document.getElementById('priceB').value = data.quotes[1].c;
                    }
                    if(data.quotes[2]) {
                        document.getElementById('provC').value = data.quotes[2].p;
                        document.getElementById('priceC').value = data.quotes[2].c;
                    }

                    calcQuotes();
                    document.getElementById('pasteArea').value = ''; // Limpiar área pegado
                    alert("✅ Datos cargados correctamente. Revisa y selecciona el proveedor.");
                } catch (e) {
                    alert("Error al leer el código. Asegúrate de copiar todo el mensaje.");
                }
            } else {
                alert("No se encontró código válido en el texto pegado.");
            }
        }

        // --- LÓGICA DE COMPRA ---
        function updateFund() {
            db.matFund = parseFloat(document.getElementById('materialFundInput').value) || 0;
            localStorage.setItem('db_matFund', db.matFund);
            updateUI();
        }

        function calcQuotes() {
            const qty = parseFloat(document.getElementById('matQty').value) || 0;
            ['A','B','C'].forEach(x => {
                const p = parseFloat(document.getElementById('price'+x).value) || 0;
                document.getElementById('total'+x).innerText = fmt(qty * p);
            });
        }

        function selectQuote(id) {
            selectedQ = id;
            ['A','B','C'].forEach(x => document.getElementById('card'+x).classList.remove('quote-selected'));
            document.getElementById('card'+id).classList.add('quote-selected');
            document.getElementById('btnBuy').disabled = false;
        }

        function registerPurchase() {
            if(!selectedQ) return;
            const qty = parseFloat(document.getElementById('matQty').value);
            const price = parseFloat(document.getElementById('price'+selectedQ).value);
            const prov = document.getElementById('prov'+selectedQ).value;
            
            const item = {
                id: Date.now(),
                name: document.getElementById('matName').value,
                prov: prov,
                qty: qty,
                total: qty * price
            };

            db.materials.unshift(item);
            localStorage.setItem('db_materials', JSON.stringify(db.materials));
            
            // Limpiar
            document.getElementById('matName').value = '';
            document.getElementById('matQty').value = '';
            ['A','B','C'].forEach(x => {
                document.getElementById('prov'+x).value = ''; 
                document.getElementById('price'+x).value = '';
                document.getElementById('total'+x).innerText = '$0.00';
                document.getElementById('card'+x).classList.remove('quote-selected');
            });
            document.getElementById('btnBuy').disabled = true;
            renderMaterials();
            updateUI();
        }

        function renderMaterials() {
            const list = document.getElementById('materialList');
            list.innerHTML = '';
            db.materials.forEach((m, idx) => {
                list.innerHTML += `
                    <div class="flex justify-between p-3 items-center hover:bg-gray-50">
                        <div>
                            <div class="font-bold">${m.name}</div>
                            <div class="text-xs text-gray-500">${m.prov} (x${m.qty})</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-gray-800">${fmt(m.total)}</div>
                            <button onclick="delMat(${idx})" class="text-red-400 text-xs hover:text-red-600">Borrar</button>
                        </div>
                    </div>`;
            });
        }

        function delMat(idx) {
            if(confirm('¿Borrar compra?')) {
                db.materials.splice(idx, 1);
                localStorage.setItem('db_materials', JSON.stringify(db.materials));
                renderMaterials();
                updateUI();
            }
        }

        function updateUI() {
            const spent = db.materials.reduce((a,b) => a + b.total, 0);
            const avail = db.matFund - spent;
            document.getElementById('matFundAvailable').innerText = fmt(avail);
            document.getElementById('displayRestante').innerText = fmt(db.budget - spent); // Simplificado
        }

        function saveBudget() {
            db.budget = parseFloat(document.getElementById('budgetInput').value) || 0;
            localStorage.setItem('db_budget', db.budget);
            updateUI();
        }

        function fmt(n) { return new Intl.NumberFormat('es-MX', {style:'currency', currency:'MXN'}).format(n); }
    </script>
</body>
</html>
